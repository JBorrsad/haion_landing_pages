name: Build and Deploy GitHub Pages

on:
	# Disparado por la Edge Function vía repository_dispatch
	repository_dispatch:
		types: [cms_update]

	# También se puede disparar manualmente
	workflow_dispatch:

permissions:
	contents: read
	pages: write
	id-token: write

# Solo un deploy a la vez
concurrency:
	group: "pages"
	cancel-in-progress: false

jobs:
	build:
		runs-on: ubuntu-latest
		
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Setup Node
				uses: actions/setup-node@v4
				with:
					node-version: '18'
					cache: 'npm'

			- name: Install dependencies
				run: npm ci

			- name: Sync content from Supabase
				env:
					SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
					SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
					DOWNLOAD_ASSETS: 'false'
				run: node scripts/sync-from-supabase.mjs

		- name: Build with Astro
			env:
				PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
				PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
			run: npm run build

			- name: Upload artifact
				uses: actions/upload-pages-artifact@v3
				with:
					path: ./dist

	deploy:
		environment:
			name: github-pages
			url: ${{ steps.deployment.outputs.page_url }}
		runs-on: ubuntu-latest
		needs: build
		
		steps:
			- name: Deploy to GitHub Pages
				id: deployment
				uses: actions/deploy-pages@v4

